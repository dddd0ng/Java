services:
  mariadb-persist:
    platform: linux/amd64        # M1ì´ë©´ ì´ê±° ìˆìœ¼ë©´ ë” ì•ˆì „
    image: mariadb:latest
    container_name: mariadb-persist
    environment:
      - MARIADB_ROOT_PASSWORD=root1234
      - MARIADB_DATABASE=calcdb
    ports:
      - "3310:3306"
    volumes:
      - mariadb-volume:/var/lib/mysql
      - mariadb-logs:/var/log/mysql
    networks:
      - camp-net
    restart: always
    ## error.log : ì—ëŸ¬ ë°œìƒì‹œ ìŒ“ì´ëŠ” ë¡œê·¸ íŒŒì¼
    ## general.log : ì¼ë°˜ ì¿¼ë¦¬ ë¡œê·¸ê°€ ìŒ“ì´ëŠ” ë¡œê·¸ íŒŒì¼
    ## slow.log : ëŠë¦° ì¿¼ë¦¬ ë¡œê·¸ê°€ ìŒ“ì´ëŠ” ë¡œê·¸ íŒŒì¼(2ì´ˆ ì´ìƒ)

    ## ì‹¤í–‰ì¤‘ì¸ mariadb-persist ì»¨í…Œì´ë„ˆë¡œ ë“¤ì–´ê°€ì„œ log íŒŒì¼ í™•ì¸
    ## docker exec -it mariadb-persist tail -f /var/log/mysql/general.log
    command: >
      --log-error=/var/log/mysql/error.log
      --general-log=1
      --general-log-file=/var/log/mysql/general.log
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=2

    
    ## healthcheck (ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸)
    ## - DBê°€ ì™„ì „íˆ ì¤€ë¹„ ë˜ì—ˆëŠ”ì§€ ì—¬ëŸ¬ë²ˆ ì‹œë„
    ## test : ì‹¤í–‰ í•  ê°ì‹œëŒ€ìƒ(DB ì—°ê²° + InnoDB ì´ˆê¸°í™” í™•ì¸)
    ## interval : 10ì´ˆë§ˆë‹¤ ì²´í¬
    ## timeout : 5ì´ˆê°„ ëŒ€ê¸°í•˜ë‹¤ ì‘ë‹µ ì—†ìœ¼ë©´ ì‹¤íŒ¨
    ## retries : 5ë²ˆ ì‹œë„
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5

  springboot-app:
    platform: linux/amd64        # M1ì—ì„œ gradle/alpine ì¡°í•© ê¹¨ì§€ëŠ” ê±° ì˜ˆë°©
    build:
      context: ./chap02_01_bootproject
      # dockerfile: Dockerfile   # ì´ë¦„ ë‹¤ë¥´ë©´ ì—¬ê¸° ì ì–´
    image: kdg1644/calc-volume:latest
    container_name: spring-calc-with-db
    ports:
      - "8055:7777"              # ğŸ‘‰ ì—¬ê¸° ì»¨í…Œì´ë„ˆê°€ ì •ë§ 7777ë¡œ ë– ì•¼ í•¨
      # ìŠ¤í”„ë§ì´ 8080ì´ë¼ë©´ ì´ë ‡ê²Œ ë°”ê¿”:
      # - "8055:8080"
    networks:
      - camp-net
    depends_on:
      mariadb-persist:
        condition: service_healthy
    restart: always

  vue-app:
    platform: linux/amd64
    build:
      context: ./chap02_02_vueproject
      # dockerfile: Dockerfile
    image: kdg1644/vue_19_project
    container_name: vue-container-integrated
    ports:
      - "8011:5173"
    networks:
      - camp-net
    depends_on:
      - springboot-app
    restart: always

volumes:
  mariadb-volume:
    driver: local
  mariadb-logs:
    driver: local

networks:
  camp-net:
    driver: bridge
